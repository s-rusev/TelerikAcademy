Disclaimer: This code is still awful (slightly better though), no time - sorry for that :)